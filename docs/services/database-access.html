<!DOCTYPE HTML>
<html lang="en" >
    
    <head>
        
        <meta charset="UTF-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <title>Database Access | H2 Micro-Services Platform</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="generator" content="GitBook 2.6.7">
        
        
        <meta name="HandheldFriendly" content="true"/>
        <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
        <meta name="apple-mobile-web-app-capable" content="yes">
        <meta name="apple-mobile-web-app-status-bar-style" content="black">
        <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
        <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">
        
    <link rel="stylesheet" href="../gitbook/style.css">
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-highlight/website.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-search/search.css">
        
    
        
        <link rel="stylesheet" href="../gitbook/plugins/gitbook-plugin-fontsettings/website.css">
        
    
    

        
    
    
    <link rel="next" href="../services/pub-sub.html" />
    
    
    <link rel="prev" href="../services/configuration.html" />
    

        
    </head>
    <body>
        
        
    <div class="book"
        data-level="2.6"
        data-chapter-title="Database Access"
        data-filepath="services/database-access.md"
        data-basepath=".."
        data-revision="Wed Aug 31 2016 13:50:38 GMT+0000 (UTC)"
        data-innerlanguage="">
    

<div class="book-summary">
    <nav role="navigation">
        <ul class="summary">
            
            
            
            

            

            
    
        <li class="chapter " data-level="0" data-path="index.html">
            
                
                    <a href="../index.html">
                
                        <i class="fa fa-check"></i>
                        
                        Introduction
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1" data-path="getting-started/index.html">
            
                
                    <a href="../getting-started/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.</b>
                        
                        Getting started
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1" data-path="getting-started/installation.html">
            
                
                    <a href="../getting-started/installation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.1.</b>
                        
                        Installation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="getting-started/setup-credentials.html">
            
                
                    <a href="../getting-started/setup-credentials.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>1.2.</b>
                        
                        Set up Credentials
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="2" data-path="services/index.html">
            
                
                    <a href="../services/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.</b>
                        
                        Services
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="2.1" data-path="services/initialisation.html">
            
                
                    <a href="../services/initialisation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.1.</b>
                        
                        Initialisation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.2" data-path="services/endpoints.html">
            
                
                    <a href="../services/endpoints.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.2.</b>
                        
                        Endpoints
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.3" data-path="services/client.html">
            
                
                    <a href="../services/client.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.3.</b>
                        
                        Client
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.4" data-path="services/security.html">
            
                
                    <a href="../services/security.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.4.</b>
                        
                        Security
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.5" data-path="services/configuration.html">
            
                
                    <a href="../services/configuration.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.5.</b>
                        
                        Configuration
                    </a>
            
            
        </li>
    
        <li class="chapter active" data-level="2.6" data-path="services/database-access.html">
            
                
                    <a href="../services/database-access.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.6.</b>
                        
                        Database Access
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.7" data-path="services/pub-sub.html">
            
                
                    <a href="../services/pub-sub.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.7.</b>
                        
                        Pub/Sub
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.8" data-path="services/distributed-synchronisation.html">
            
                
                    <a href="../services/distributed-synchronisation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.8.</b>
                        
                        Distributed Synchronisation
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.9" data-path="services/healthchecks.html">
            
                
                    <a href="../services/healthchecks.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.9.</b>
                        
                        Healthchecks
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="2.10" data-path="services/instrumentation.html">
            
                
                    <a href="../services/instrumentation.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>2.10.</b>
                        
                        Instrumentation
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3" data-path="architecture/index.html">
            
                
                    <a href="../architecture/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.</b>
                        
                        Architecture
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1" data-path="architecture/service-architecture/index.html">
            
                
                    <a href="../architecture/service-architecture/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.</b>
                        
                        Service Architecture
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.1.1" data-path="architecture/service-architecture/rpc.html">
            
                
                    <a href="../architecture/service-architecture/rpc.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.1.</b>
                        
                        RPC
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.1.2" data-path="architecture/service-architecture/apis.html">
            
                
                    <a href="../architecture/service-architecture/apis.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.2.</b>
                        
                        APIs
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.1.3" data-path="architecture/service-architecture/kernel-services.html">
            
                
                    <a href="../architecture/service-architecture/kernel-services.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.3.</b>
                        
                        Kernel Services
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.1.4" data-path="architecture/service-architecture/deployment.html">
            
                
                    <a href="../architecture/service-architecture/deployment.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.1.4.</b>
                        
                        Deployment
                    </a>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.2" data-path="architecture/shared-infrastructure/index.html">
            
                
                    <a href="../architecture/shared-infrastructure/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.</b>
                        
                        Shared Infrastructure
                    </a>
            
            
            <ul class="articles">
                
    
        <li class="chapter " data-level="3.2.1" data-path="architecture/shared-infrastructure/cassandra.html">
            
            <span><b>3.2.1.</b> Cassandra</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.2" data-path="architecture/shared-infrastructure/logging.html">
            
                
                    <a href="../architecture/shared-infrastructure/logging.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>3.2.2.</b>
                        
                        Logging
                    </a>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.3" data-path="architecture/shared-infrastructure/memcached.html">
            
            <span><b>3.2.3.</b> Memcached</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.4" data-path="architecture/shared-infrastructure/nsq.html">
            
            <span><b>3.2.4.</b> NSQ</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.5" data-path="architecture/shared-infrastructure/puppet.html">
            
            <span><b>3.2.5.</b> Puppet</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.6" data-path="architecture/shared-infrastructure/rabbitmq.html">
            
            <span><b>3.2.6.</b> RabbitMQ</span>
            
            
        </li>
    
        <li class="chapter " data-level="3.2.7" data-path="architecture/shared-infrastructure/zookeeper.html">
            
            <span><b>3.2.7.</b> Zookeeper</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="3.3" data-path="architecture/network-architecture/index.html">
            
            <span><b>3.3.</b> Network Architecture</span>
            
            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="4" data-path="tooling/index.html">
            
                
                    <a href="../tooling/index.html">
                
                        <i class="fa fa-check"></i>
                        
                            <b>4.</b>
                        
                        Tooling
                    </a>
            
            
        </li>
    


            
            <li class="divider"></li>
            <li>
                <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
                    Published with GitBook
                </a>
            </li>
            
        </ul>
    </nav>
</div>

    <div class="book-body">
        <div class="body-inner">
            <div class="book-header" role="navigation">
    <!-- Actions Left -->
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href="../" >H2 Micro-Services Platform</a>
    </h1>
</div>

            <div class="page-wrapper" tabindex="-1" role="main">
                <div class="page-inner">
                
                
                    <section class="normal" id="section-">
                    
                        <h1 id="database-access">Database Access</h1>
<p>At Hailo we use Cassandra as our primary data store and have a number of utilities to make your life easier when using Cassandra. In this section we will not be covering how to store your data in Cassandra but how to setup and manage your services connection to Cassandra.</p>
<p>Most of the work for dealing with Cassandra is handled by one of two components, the service layer creates the connection to the database and handles the reloading of the connection whenever the configuration changes. The other component is a helper library called <a href="https://github.com/HailoOSS/gocassa" target="_blank">gocassa</a> that we maintain. This library provides a number of opinionated recipes for how you should store and query your data and then builds the queries. We find that this helps prevent mistakes when using a database like Cassandra which is new to many developers.</p>
<h2 id="connecting-to-cassandra">Connecting to Cassandra</h2>
<p>Connecting to Cassandra is handled by the service layer however there are still some steps required before you can query the database. The service layer also deals with configuration updates and host updates. To setup the connection it is recommended that you create a function in <code>dao/dao.go</code> for setting everything up, this function might look something like this:</p>
<pre><code class="lang-go"><span class="hljs-keyword">import</span> (
    ...

    gc <span class="hljs-string">&quot;github.com/HailoOSS/gocassa&quot;</span>
)

<span class="hljs-keyword">type</span> cassandraStore <span class="hljs-keyword">struct</span> {
    Keyspace      gocassa.KeySpace
    FooTable      gocassa.MultimapTable
}

<span class="hljs-keyword">func</span> New(keyspace keyspace gc.KeySpace) *cassandraStore {
    store := &amp;cassandraStore{
        Keyspace: keyspace,
    }
    store.FooTable = keyspace.MapTable(<span class="hljs-string">&quot;foos&quot;</span>, <span class="hljs-string">&quot;Id&quot;</span>, Foo{})

    <span class="hljs-comment">// Create tables</span>
    <span class="hljs-keyword">if</span> err := store.FooTable.CreateIfNotExists(); err != <span class="hljs-constant">nil</span> {
        log.Errorf(<span class="hljs-string">&quot;Failed to create table: %s&quot;</span>, err)
    }
}
</code></pre>
<p>This can then be called in your <code>main.go</code> file like this:</p>
<pre><code class="lang-go"><span class="hljs-keyword">import</span> (
    ...
    <span class="hljs-string">&quot;github.com/HailoOSS/service/gocassa&quot;</span>
)

<span class="hljs-keyword">func</span> main() {
    service.Init()
    ...
    store := dao.New(gocassa.Keyspace())

    <span class="hljs-comment">// Pass the store to any package that needs it, for example lets pass the store to our handlers</span>
    handlers := handler.Init(store)
    service.Register(&amp;service.Endpoint{
        Name:             <span class="hljs-string">&quot;hello&quot;</span>,
        Handler:          handlers.Hello,
        ...
    })
    ...
    service.Run()
}
</code></pre>
<p>Lets now go over this code to make sure we understand what is going on, the first thing we do is import the gocassa library and define a new data structure. This structure holds the gocassa keyspace and any tables that the service uses. Some services also store these as global variables however by storing them in a separate structure and passing an instance to this around we make our code much easier to test.</p>
<p>The next section of code is the <code>New</code> function, this function accepts a gocassa <code>KeySpace</code> and returns an instance of the store. The <code>Keyspace</code> can either be used for connecting to a real database (by using a Keyspace from the service layer) or mocking (by using the <code>NewMockKeySpace</code> function in gocassa). Using this keyspace we next setup the tables and attempt to create the actual tables in the Cassandra. For more information about the different types of tables and how to create them check the <a href="https://github.com/HailoOSS/gocassa" target="_blank">gocassa docs</a>.</p>
<p>The final section of code is <code>main.go</code>, here we create an instance of the store passing in the gocassa keyspace from the service layer. We can then pass instance of the store to any parts of the service that require it, for example we pass the store to the handlers.</p>
<h2 id="healthchecks">Healthchecks</h2>
<p>The service layer includes a healthcheck which checks that all tables are created and accessible and any service that uses gocassa should use it. To register the healthcheck just include this line in your <code>main.go</code> after you have initialised your connection and before <code>service.Run()</code>, for example:</p>
<pre><code class="lang-go">service.HealthCheck(gocassa.HealthCheckId, gocassa.HealthCheck(store.Keyspace, store.FooTable, store.BarTable, ...))
</code></pre>
<h2 id="queries">Queries</h2>
<p>This section will give you an overview of how to make queries using gocassa however for a more detailed overview you should see the <a href="https://github.com/HailoOSS/gocassa" target="_blank">gocassa docs</a>. Once you have passed the store down to the part of your code that is going to make the query and you have created a table using the correct recipe (such as MapTable, MultimapTable, TimeSeriesTable) you can now start to read and write data.</p>
<p>Each table recipe has various functions for querying the data however to give you an idea of how this works here are some examples:</p>
<p>Writing a row to a <code>MapTable</code>, you can also pass a struct value to this function and it will extract any exported fields</p>
<pre><code class="lang-go"><span class="hljs-keyword">if</span> err := store.FooTable.Set(<span class="hljs-keyword">map</span>[<span class="hljs-typename">string</span>[]<span class="hljs-keyword">interface</span>{}{
    <span class="hljs-string">&quot;Id&quot;</span>:   <span class="hljs-number">1</span>,
    <span class="hljs-string">&quot;Name&quot;</span>: <span class="hljs-string">&quot;baz&quot;</span>,
}).Run(); err != <span class="hljs-constant">nil</span> {
    <span class="hljs-comment">// Error</span>
}
</code></pre>
<p>To read data from a <code>MapTable</code>:</p>
<pre><code class="lang-go"><span class="hljs-keyword">var</span> result <span class="hljs-keyword">map</span>[<span class="hljs-typename">string</span>]<span class="hljs-keyword">interface</span>{}
<span class="hljs-keyword">if</span> err := store.FooTable.Read(<span class="hljs-number">1</span>, &amp;result).Run(); err != <span class="hljs-constant">nil</span> {
    <span class="hljs-built_in">panic</span>(err)
}
fmt.Println(result)
</code></pre>
<h2 id="structuring-your-code">Structuring your code</h2>
<p>Generally H2 services store all their code for accessing the databaes in the <code>dao</code> package and as mentioned previously any data types are stored in the <code>domain</code> package.</p>
<p>Inside the <code>dao</code> package most services contain a file named <code>dao.go</code> which does any initialisation and contains any interfaces used for accessing the database.</p>

                    
                    </section>
                
                
                </div>
            </div>
        </div>

        
        <a href="../services/configuration.html" class="navigation navigation-prev " aria-label="Previous page: Configuration"><i class="fa fa-angle-left"></i></a>
        
        
        <a href="../services/pub-sub.html" class="navigation navigation-next " aria-label="Next page: Pub/Sub"><i class="fa fa-angle-right"></i></a>
        
    </div>
</div>

        
<script src="../gitbook/app.js"></script>

    
    <script src="../gitbook/plugins/gitbook-plugin-search/lunr.min.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-search/search.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-sharing/buttons.js"></script>
    

    
    <script src="../gitbook/plugins/gitbook-plugin-fontsettings/buttons.js"></script>
    

<script>
require(["gitbook"], function(gitbook) {
    var config = {"highlight":{},"search":{"maxIndexSize":1000000},"sharing":{"facebook":true,"twitter":true,"google":false,"weibo":false,"instapaper":false,"vk":false,"all":["facebook","google","twitter","weibo","instapaper"]},"fontsettings":{"theme":"white","family":"sans","size":2}};
    gitbook.start(config);
});
</script>

        
    </body>
    
</html>
